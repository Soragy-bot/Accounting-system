# Accounting-system

Система учета для управления кассой и расчета зарплаты сотрудников.

## Функциональность

- **Аутентификация** - вход через Telegram OAuth с поддержкой JWT токенов
- **Панель администратора** - управление настройками системы и токенами МойСклад
- **Подсчет кассы** - учет денежных операций с сохранением истории в базе данных
- **Расчет зарплаты** - калькулятор зарплаты с экспортом в Excel
  - Ручной ввод данных
  - Интеграция с API МойСклад для автоматической загрузки данных о продажах
  - Расчет бонусов за продажи и целевые товары
  - Сохранение истории расчетов в базе данных
- **Темная тема** - переключение между светлой и темной темой с выбором цветовой палитры
- **История операций** - просмотр последних подсчетов кассы и зарплаты
- **Автосохранение черновиков** - автоматическое сохранение незавершенных операций в локальном хранилище

## Технологии

### Frontend
- **React 18** - UI библиотека
- **TypeScript** - типизированный JavaScript
- **Vite 7** - сборщик и dev-сервер
- **React Router 6** - маршрутизация
- **xlsx-js-style** - экспорт в Excel с форматированием

### Backend
- **Express** - веб-сервер и API
- **PostgreSQL** - база данных
- **JWT** - аутентификация и авторизация
- **node-pg-migrate** - миграции базы данных

### Инструменты разработки
- **Jest** - фреймворк для тестирования
- **Testing Library** - утилиты для тестирования React компонентов

### Архитектура
- **Feature-Sliced Design (FSD)** - архитектура проекта
- **Docker** - контейнеризация приложения

## Установка

```bash
npm install
```

## Настройка переменных окружения

Создайте файл `.env` в корне проекта на основе `.env.example`:

```bash
cp .env.example .env
```

Заполните следующие переменные:

### Обязательные переменные:

- `DATABASE_URL` - строка подключения к PostgreSQL (например: `postgresql://user:password@localhost:5432/accounting_db`)
- `JWT_SECRET` - секретный ключ для JWT access токенов (минимум 32 символа, рекомендуется использовать случайную строку)
- `JWT_REFRESH_SECRET` - секретный ключ для JWT refresh токенов (минимум 32 символа, должен отличаться от JWT_SECRET)
- `ENCRYPTION_KEY` - ключ для шифрования токена МойСклад (ровно 32 символа)
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота (получить у @BotFather)
- `TELEGRAM_CLIENT_ID` - ID Telegram приложения (bot_id от @BotFather)
- `TELEGRAM_CLIENT_SECRET` - секрет Telegram приложения (получить у @BotFather)
- `TELEGRAM_DOMAIN` - домен вашего приложения для Telegram OAuth (без протокола, например: `example.com`)
- `FRONTEND_URL` - URL фронтенда для редиректа после авторизации (например: `https://example.com`)

### Опциональные переменные:

- `PORT` - порт для запуска сервера (по умолчанию: `8880`)
- `JWT_ACCESS_EXPIRY` - время жизни access токена (по умолчанию: `15m`)
- `JWT_REFRESH_EXPIRY` - время жизни refresh токена (по умолчанию: `7d`)
- `CORS_ORIGIN` - разрешенные источники для CORS (по умолчанию: `*` для всех)
- `POSTGRES_USER` - пользователь PostgreSQL (по умолчанию: `postgres`)
- `POSTGRES_PASSWORD` - пароль PostgreSQL (по умолчанию: `postgres`)
- `POSTGRES_DB` - имя базы данных (по умолчанию: `accounting_db`)
- `POSTGRES_PORT` - порт PostgreSQL (по умолчанию: `5432`)

### Настройка Telegram OAuth:

1. Создайте бота через [@BotFather](https://t.me/BotFather)
2. Получите токен бота (`TELEGRAM_BOT_TOKEN`)
3. Зарегистрируйте домен в настройках бота:
   - Откройте [@BotFather](https://t.me/BotFather) в Telegram
   - Отправьте команду `/newapp` или `/editapp`
   - Выберите вашего бота
   - Укажите домен вашего сайта (например, `example.com`)
   - Telegram вернет вам `bot_id`, который нужно использовать как `TELEGRAM_CLIENT_ID`
4. Настройте переменные окружения в `.env`:
   ```env
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   TELEGRAM_CLIENT_ID=bot_id_от_BotFather
   TELEGRAM_DOMAIN=example.com
   FRONTEND_URL=https://example.com
   ```

### Настройка базы данных:

1. Убедитесь, что PostgreSQL запущен (через Docker Compose или отдельно)
2. Настройте переменную `DATABASE_URL` в `.env` файле:
   ```env
   DATABASE_URL=postgresql://postgres:postgres@localhost:5432/accounting_db
   ```
3. При первом запуске приложения миграции применятся автоматически
4. Или запустите миграции вручную: `npm run migrate`

**Важно:** Все данные (операции кассы, расчеты зарплаты, настройки) сохраняются в базе данных PostgreSQL. Локальное хранилище используется только для черновиков и временных данных.

## Запуск

### Разработка

```bash
# Запуск PostgreSQL через Docker Compose
docker-compose up -d postgres

# Применение миграций БД
npm run migrate

# Запуск фронтенда (dev сервер)
npm run dev

# Запуск бэкенда (в отдельном терминале)
npm start
```

### Production

```bash
# Сборка фронтенда
npm run build

# Запуск через Docker Compose (включает PostgreSQL и приложение)
docker-compose up -d

# Или запуск только приложения
npm start
```

## Структура проекта

Проект использует архитектуру **Feature-Sliced Design (FSD)** для лучшей организации кода:

```
src/
  ├── features/              # Бизнес-логика приложения
  │   ├── admin/             # Модуль администратора
  │   │   └── components/    # Компоненты админ-панели
  │   ├── auth/              # Модуль аутентификации
  │   │   └── components/    # Компоненты входа и авторизации
  │   ├── cash-counter/      # Модуль подсчета кассы
  │   │   ├── components/    # Компоненты модуля
  │   │   ├── services/      # Бизнес-логика и утилиты
  │   │   ├── hooks/         # Кастомные хуки модуля
  │   │   ├── constants.ts   # Константы модуля
  │   │   └── types.ts       # Типы модуля
  │   └── salary-calculator/ # Модуль расчета зарплаты
  │       ├── components/    # Компоненты модуля
  │       ├── services/      # Бизнес-логика и утилиты
  │       ├── constants.ts   # Константы модуля
  │       └── types.ts       # Типы модуля
  ├── shared/                # Переиспользуемые модули
  │   ├── api/              # API клиенты
  │   │   ├── admin/        # API администратора
  │   │   ├── auth/         # API аутентификации
  │   │   ├── cash/         # API кассы
  │   │   ├── salary/       # API зарплаты
  │   │   ├── moysklad/     # API МойСклад
  │   │   └── storage/      # Утилиты для работы с хранилищем
  │   ├── components/        # Общие UI компоненты
  │   ├── hooks/            # Общие хуки
  │   ├── utils/            # Общие утилиты
  │   ├── constants.ts      # Общие константы
  │   └── types/            # Общие типы
  ├── pages/                 # Страницы приложения
  │   ├── HomePage.tsx      # Главная страница
  │   ├── CashCounter.tsx   # Страница подсчета кассы
  │   ├── SalaryCalculator.tsx # Страница расчета зарплаты
  │   └── AdminPage.tsx     # Страница администратора
  ├── contexts/             # React контексты
  │   ├── AuthContext.tsx   # Контекст аутентификации
  │   ├── ThemeContext.tsx  # Контекст темы
  │   └── NotificationContext.tsx # Контекст уведомлений
  ├── App.tsx               # Корневой компонент
  ├── main.tsx              # Точка входа
  └── types.ts              # Глобальные типы (legacy, используется через re-export)

server/
  ├── config/               # Конфигурация сервера
  │   ├── database.js       # Настройки базы данных
  │   ├── env.js           # Переменные окружения
  │   └── jwt.js           # Настройки JWT
  ├── controllers/          # Контроллеры API
  │   ├── admin.controller.js
  │   ├── auth.controller.js
  │   ├── cash.controller.js
  │   └── salary.controller.js
  ├── db/                   # Работа с базой данных
  │   ├── migrate.js       # Скрипт миграций
  │   └── migrations/      # Файлы миграций
  ├── middleware/           # Промежуточное ПО
  │   ├── auth.middleware.js # Аутентификация
  │   └── rbac.middleware.js # Роли и права доступа
  ├── models/              # Модели данных
  │   ├── User.js
  │   ├── CashEntry.js
  │   ├── SalaryCalculation.js
  │   └── MoyskladSettings.js
  ├── routes/              # Маршруты API
  │   ├── admin.routes.js
  │   ├── auth.routes.js
  │   ├── cash.routes.js
  │   └── salary.routes.js
  └── services/            # Бизнес-логика сервера
      ├── auth.service.js
      ├── cash.service.js
      ├── salary.service.js
      ├── moysklad.service.js
      └── encryption.service.js
```

## Использование

1. Откройте приложение в браузере
2. Выполните вход через Telegram OAuth (если еще не авторизованы)
3. Выберите нужный инструмент (Подсчет кассы или Расчет зарплаты)
4. Введите данные и сохраните результат

### Авторизация

Приложение использует аутентификацию через Telegram OAuth:

1. При первом посещении вы будете перенаправлены на страницу входа
2. Нажмите кнопку "Войти через Telegram"
3. Подтвердите вход в Telegram
4. После успешной авторизации вы будете перенаправлены в приложение
5. Токены автоматически обновляются при необходимости

### Настройка интеграции с API МойСклад

Для автоматической загрузки данных о продажах в модуле "Расчет зарплаты":

1. Перейдите в раздел "Расчет зарплаты"
2. Переключите режим на "API"
3. Введите токен доступа МойСклад (можно получить в личном кабинете МойСклад: Настройки → API → Токены доступа)
4. Нажмите "Проверить подключение"
5. Выберите розничную точку продажи из списка
6. При выборе рабочих дней данные будут автоматически загружаться из API

**Примечание:** Данные можно редактировать вручную после загрузки из API. При ручном изменении данные помечаются как "ручные" и не перезагружаются автоматически.

## Разработка

### Архитектура проекта

Проект использует архитектуру **Feature-Sliced Design (FSD)**, которая обеспечивает:

- **Модульность** - каждый функциональный модуль изолирован
- **Переиспользование** - общие компоненты и утилиты в слое `shared`
- **Масштабируемость** - легко добавлять новые функции
- **Поддерживаемость** - четкая структура упрощает навигацию по коду

### Структура модулей

Каждый модуль в `features/` содержит:
- `components/` - UI компоненты модуля
- `services/` - бизнес-логика и утилиты
- `hooks/` - кастомные React хуки (опционально)
- `constants.ts` - константы модуля
- `types.ts` - TypeScript типы модуля

### Тестирование

Проект использует Jest и Testing Library для тестирования:

```bash
# Запустить все тесты
npm test

# Запустить тесты в режиме watch
npm run test:watch

# Запустить тесты с отчетом о покрытии
npm run test:coverage
```

### Добавление нового функционала

1. Создайте новую папку в `features/` с именем модуля
2. Добавьте необходимые подпапки (`components/`, `services/`, и т.д.)
3. Используйте `shared/` для переиспользуемых компонентов и утилит
4. Создайте страницу в `pages/` для нового функционала
5. Добавьте маршрут в `App.tsx`
6. При необходимости создайте API endpoints в `server/`
7. Добавьте тесты для нового функционала

## Развертывание на сервере с Docker

### Требования

- Docker (версия 20.10 или выше)
- Docker Compose (версия 2.0 или выше)

### Быстрый старт с Docker Compose

1. **Клонируйте репозиторий или скопируйте файлы на сервер**

2. **Перейдите в директорию проекта**
```bash
cd Accounting-system
```

3. **Соберите и запустите контейнер**
```bash
docker-compose up -d --build
```

4. **Приложение будет доступно по адресу:**
   - `http://localhost:8880` (локально)
   - `http://utilites.psihbolnitsa.ru:8880` (через домен)
   - `http://your-server-ip:8880` (напрямую по IP)

### Управление контейнером

```bash
# Остановить контейнер
docker-compose down

# Перезапустить контейнер
docker-compose restart

# Просмотр логов
docker-compose logs -f

# Остановить и удалить контейнер с данными
docker-compose down -v
```

### Развертывание без Docker Compose

1. **Соберите Docker образ**
```bash
docker build -t accounting-system:latest .
```

2. **Запустите контейнер**
```bash
docker run -d \
  --name accounting-system \
  -p 8880:8880 \
  --restart unless-stopped \
  accounting-system:latest
```

3. **Управление контейнером**
```bash
# Остановить
docker stop accounting-system

# Запустить
docker start accounting-system

# Удалить
docker rm -f accounting-system

# Просмотр логов
docker logs -f accounting-system
```

### Настройка домена и порта

Приложение настроено на работу с доменом `utilites.psihbolnitsa.ru` на порту `8880`.

#### Настройка DNS

1. **Настройте DNS запись** для домена `utilites.psihbolnitsa.ru`:
   - Тип: `A`
   - Имя: `utilites` (или `@` для корневого домена)
   - Значение: IP-адрес вашего сервера
   - TTL: 3600 (или по умолчанию)

#### Настройка внешнего Nginx (опционально)

Если на сервере уже установлен Nginx, можно настроить проксирование:

```nginx
server {
    listen 80;
    server_name utilites.psihbolnitsa.ru;

    location / {
        proxy_pass http://localhost:8880;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

После настройки перезапустите внешний Nginx:
```bash
sudo nginx -t  # Проверка конфигурации
sudo systemctl reload nginx  # Перезагрузка
```

#### Изменение порта

Если нужно изменить порт, отредактируйте `docker-compose.yml`:

```yaml
ports:
  - "8880:8880"  # Внешний порт:Внутренний порт
```

Или при запуске через `docker run`:

```bash
docker run -d -p 8880:8880 --name accounting-system accounting-system:latest
```

### Обновление приложения

1. **Остановите текущий контейнер**
```bash
docker-compose down
```

2. **Получите последние изменения** (если используете git)
```bash
git pull
```

3. **Пересоберите и запустите**
```bash
docker-compose up -d --build
```

### Проблемы и решения

**Проблема:** Порт уже занят
- **Решение:** Измените порт в `docker-compose.yml` или остановите службу, использующую порт 8880

**Проблема:** Ошибка при сборке
- **Решение:** Убедитесь, что все файлы проекта скопированы, включая `package.json` и `package-lock.json`

**Проблема:** Приложение не открывается
- **Решение:** Проверьте логи: `docker-compose logs -f` или `docker logs accounting-system`

**Проблема:** Ошибка подключения к базе данных
- **Решение:** Убедитесь, что PostgreSQL контейнер запущен и переменная `DATABASE_URL` настроена правильно

**Проблема:** Ошибка авторизации через Telegram
- **Решение:** Проверьте, что все переменные окружения для Telegram OAuth настроены корректно, включая `TELEGRAM_DOMAIN` и `FRONTEND_URL`

**Проблема:** Миграции не применяются
- **Решение:** Убедитесь, что база данных доступна и запустите миграции вручную: `npm run migrate`

